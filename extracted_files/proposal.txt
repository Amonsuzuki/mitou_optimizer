プロジェクト名： TEE を用いたセキュアかつ高性能なデータベースシステムの開発  申請者名：福山将英  【提案プロジェクト詳細】  1   何を作るか  1.1   概要  クラウドの利用は増加の一途を辿っている。令和 4 年版情報通信白書   [1] によると、 2020 年の時点でクラウド  サービス市場規模は 3281 億ドルと、 2017 年の 1640 億ドルと比較して 2 倍ほど拡大しており、今後も市場は拡  大していくと考えられている。 Google や Microsoft 、 Amazon などの大企業がクラウド事業を提供しており、それ  らは外部からの攻撃に対する様々な策を講じているため、安全であると考えられている。しかし、安心は満た  されていない。なぜなら、クラウド事業者は自身が提供しているマシンの管理者権限を有しているため、彼ら  がデータの読み取りや改ざんを行うかもしれない、という疑念が残るからだ。クラウドを利用するときは当然、  組織の重要なデータベースをクラウドにおいて運用するが、クラウド事業者等の管理者権限を有する者が不  正アクセスを行っていないことを保証するのは難しい。  本提案では、メニーコア環境下で性能を発揮できる、セキュアかつ高性能なトランザクション処理システムを  有するデータベースシステムを開発し、この問題を解決する。具体的には、 Intel SGX によって提供される隔離  実行環境である Enclave 内部に、トランザクション処理プロトコルの Silo 、インデックス及び機密データを配置す  ることにより、 OS やハイパーバイザ、クラウド事業者からの読み取り、改ざんを防ぐ。  図 1   システム概要図  本手法では、楽観的並行性制御法と並列ロギングを利用することによりトランザクション処理の性能を改善  する。また、書き出したログの整合性を保証するためにログ改ざん検知プロトコルを実装する。これらによって  データの機密性、完全性を保証する。  近年の実証実験では、 LayerX が提供する Intel SGX を基に開発された Anonify を用いて、インターネット投票  における秘匿性と完全性を保証するというものがある   [2] 。このような技術は金融や連合学習など、処理性能  を求められ、かつ情報資産を扱う分野において必要である。このプロジェクトは、データの機密性を保持しつ  つ処理性能を向上させることで、性能要求とセキュリティの確保のニーズを同時に満たしているため、情報資  産を扱うあらゆる分野において応用が可能であると考えている。  1.2   背景  セキュリティの重要性  近年、クラウドコンピューティングの普及が加速し、今や組織の機密情報などが含まれているデータベース  でさえも、クラウドに置いて運用するのが主流となっている。しかし、それはクラウド事業者を無条件に信頼す  るという前提が置かれている。従来のオンプレミス型であれば、外部からの不正アクセスに対する防御措置を  取る必要があるが、クラウドではそれに加えてクラウド事業者自身が不正アクセスを行わないかを考慮する必  1
要がある。なぜなら、クラウド事業者は自身のマシンの管理者権限を有しているため、メモリ上のデータは理  論上読み取ることが可能であるからだ。当然、機密情報は機密性を保証する必要があるが、クラウドコン  ピューティングでは上記の理由から機密性は保証されていない。  Confidential Computing  これを解決する技術として、準同型暗号を用いる秘密計算や、複数のサーバを用いる秘密分散が研究開発  されてきた。これに加えて、近年立ち上がりつつある技術に機密計算 (Confidential Computing) がある。機密  計算とはデータ処理を暗号化した状態で行い、データの機密性を確保するというものである。機密計算は  Trusted Execution Environment(TEE) と呼ばれる特殊なデバイスを用いる。 TEE は現実的なパフォーマンス  で機密性を保証できる技術として注目を集めている。 TEE はハードウェア支援によって隔離実行環境を提供  する。 TEE の 1 つである Intel SGX は、データを暗号化し、隔離実行環境である Enclave で保持する。データ処  理を行う際は、 CPU 内にある Memory Encryption Engine(MEE) によって復号化 / 暗号化され、 CPU キャッシュ  上のみ復号化される。上記の性質から、 Intel SGX は CPU と CPU 事業者である Intel だけを信頼すれば OS や  ハイパーバイザを信頼しなくてよい設計になっている。  従来研究・手法  データベースのセキュリティを確保する手法として様々な技術が提案されてきた。提案手法は大きく分けて 2  つあり、データを暗号化してそのまま処理する手法と、 TEE を用いてデータの機密性を保証する手法である。  データを暗号化してそのまま処理する手法としては、 CryptDB [3] や MONOMI [4] などが挙げられる。これら  は準同型暗号や検索可能暗号、順序保存暗号をデータに適用し、暗号化したままデータの処理を行うという  ものである。しかし、暗号演算による法外なオーバーヘッドが発生し、実行できる命令にも制限がかかるた  め、汎用的なデータベースに適用するには難しい。  TEE を用いてデータの機密性を確保する手法としては、 Always Encrypted [5] や ShieldStore [6] 、  EnclaveDB [7] などが挙げられる。これらは TEE である Intel SGX の機能を活用してデータの機密性を保証す  るというものである。しかし、旧来型の並行性制御法や逐次ロギングを採用していることから、スケールアップ  を行うことが難しい。  これらは総じて、今後の分散環境下におけるスケールアップが難しい設計になっており、加えて OSS として  提供されていないため、アルゴリズムの改善、エッジデバイスへの応用などが不可能であることはもちろんの  こと、クラウド事業者が機密性を保ったデータベースを提供することがそもそもできないのが現状である。  1.3   作るもの  以上のことを踏まえ、メニーコア環境下に置いてもスケーラブルであり、セキュリティが確保できる本提案は  価値がある。本プロジェクトでは、メニーコア環境下で性能を発揮できるセキュアかつ高性能なデータベースシ  ステムを開発する。  2
1.3.1   設計  図 2   本システムの概観  図 2 に本システムの概観を示す。本システムは Key-Value Store として開発を行う。データ構造は ( Key ,  Value ) のタプルであり、 Key は String 型、 Value は int 型で構成される。トランザクション処理エンジンとして Silo  [8] 、データ検索用のインデックスとして Masstree [9] を採用する。また、耐故障性を付与するためにロギング処  理を行い、その完全性を保証するためにログ改ざん検知プロトコルを実装する。  Key-Value Store Interface  KVS Inferface はユーザーがデータに対して検索及び更新を行うために使用するものである。ユーザーは  CLI に Read や Write 等の命令とその引数を入力し送信すると、 Enclave 内部に渡され、パーサーで解析、 Silo  エンジンでインデックスとテーブルに対して操作を行い、その結果を CLI に返却する。例えば、ユーザーが  (“Hoge”, 100) を追加したい場合は、「 Insert Hoge 100 」と入力し、正常に処理が完了した場合は完了通知、  既に Key が使用されている場合はエラーを返しその旨を通知する。この一連の処理は Enclave 内部で実行さ  れるため、データの機密性が保証されている。使用できる命令として Read, Write, Insert, Remove, Scan を実  装する。これらの命令は必要に応じて 1 つ以上の引数を受け取り処理を行う。詳細は以下のとおりである。  ●   Read( Key )  ○   Read 命令は既にテーブルに存在する Key を検索し、その値を返却する。  ○   成功時の返り値： Value  ○   失敗時の返り値： ERROR( Key が存在しない、不適切な引数等 )  ●   Write( Key ,   Value )  ○   Write 命令は既にテーブルに存在する Key に対応する Value を書き換える。  ○   成功時の返り値： SUCCESS  ○   失敗時の返り値： ERROR( Key が存在しない、不適切な引数等 )  ●   Insert( Key ,   Value )  ○   Insert 命令はテーブルに新しく ( Key ,   Value ) のデータを追加する。  ○   成功時の返り値： SUCCESS  ○   失敗時の返り値： ERROR( Key が既に存在する、不適切な引数等 )  ●   Remove( Key ,   Value )  ○   Remove 命令は既にテーブルに存在する ( Key ,   Value ) のデータを削除する  ○   成功時の返り値： SUCCESS  ○   失敗時の返り値： ERROR( Key が存在しない、不適切な引数等 )  ●   Scan( Key ,   number )  ○   Scan 命令は Key を始めに number 個分の ( Key ,   Value ) データを検索し、それらの Key と  Value を返却する。  3
○   成功時の返り値： number 個分の ( Key ,   Value )  ○   失敗時の返り値： ERROR( Key が存在しない、不適切な引数等 )  Silo  Silo はメニーコアと大容量メモリを活用できるように設計されたトランザクション処理技法である。  Silo は読み取りロックを取得せず、代わりに検証を行い整合性を保証する楽観的並行性制御であり、書き込  みロックに関してもロックマネージャで集中管理せず、各データがロック状態を保持する非中央型ロック機構を  採用している。これにより、全体のロック時間が減少するため、メニーコア環境でも高いスループットを達成す  ることが知られている。また、 Silo は並列ロギングが可能な設計になっているため、並列性を有する近代的ス  トレージデバイスを活用して性能低下を抑えることができる。  図 3   Silo の概観  図 3 に Silo の概観を示す。 Silo はトランザクションを処理するワーカースレッドと、ロギング処理を行うロガース  レッドによって構成されている。各ワーカースレッドはテーブルのデータを用いてトランザクションを実行する。  実行が完了しコミットフェーズに入ると、ワーカースレッドはトランザクションの書き込みリストに関するログレ  コードを生成し、ワーカースレッドが保有するログバッファに登録する。  ログバッファが一杯になるかエポックが更新されると、ワーカースレッドはログバッファを対応するロガース  レッドのログキューに追加し、待機しているロガースレッドを起床させる。ワーカースレッドはログバッファを複  数保有しており、ワーカースレッドはログバッファをロガースレッドのログキューに追加後、現在のログバッファ  を置き換えて処理を続行する。  起床したロガースレッドは、ログキューの先頭にあるログバッファをストレージデバイスに書き出し永続化を  行う。永続化完了後、再利用できるようにログバッファを空にしてワーカースレッドに返却し、次の起床命令ま  で待機する。  ログ改ざん検知プロトコル  データベースシステムへの耐故障性を付与するためにトランザクションの結果をログとして出力しているが、  復元時に全てのログが揃わないと一貫性のない復元が行われてしまい完全性が失われる。これを保証する  手法として、ログの改ざん検知プロトコルを実装する。 EnclaveDB ではログを利用したハッシュ木を生成して整  合性を検証しているが、並列ロギングではログ書き出し時に全てのログレコードが揃う設計ではないため、そ  のまま適用することができない。その為、並列ロギングに対応したログ改ざん検知プロトコルを実装する。  4
本システムを実現するために必要な実装物一覧  ●   KVS インターフェース  ●   Enclave 内部で動作する Masstree インデックス  ●   Enclave 内部で動作する Silo プロトコル  ●   ログ改ざん検知プロトコル  1.3.2   到達目標  未踏プロジェクトでの本システムの到達目標は以下の通りである。  ●   SGX の仕様に適用した Silo プロトコルと Masstree の実装を行う。  ●   KVS インタフェースでユーザーとの対話を可能にする。  ●   ログ改ざん検知プロトコルを実装し完全性の確保を行う。  ●   これらを隔離実行環境下で動かし機密性を保証する。  2   どんな出し方を考えているか  実装したシステムは OSS として公開する。簡単な環境構築を行えば誰でもこのシステムの機能を使うことが  できる。 SGX は隔離実行環境をシミュレートする機能を有しているため、必要な環境条件を満たしていなくても  疑似動作を体験できる。  加えて、実装したシステムを Microsoft 、 Google に売り込むことを検討している。なぜなら、 Microsoft は  Confidential Computing として EnclaveDB を提案、 Google はクラウドサービスとして Google Cloud Spanner を  提供しているが、本システムは EnclaveDB よりも高い分離レベルと並列ロギングによるスケーラビリティを提  供し、 Google Cloud Spanner で採用されている Two-phase locking よりも高速な並行性制御法の Silo を使用  しているため、これらの既存手法よりも優位性があるからだ。  また、クラウドコンピューティング系の学会に投稿し、システムの認知及びブラッシュアップも検討している。  3   斬新さの主張、期待される効果など  3.1   斬新さの主張  前述の通り、本システムは Microsoft の EnclaveDB や Google の Google Cloud Spanner よりも高性能、高分  離レベル、スケーラビリティを有し、かつ TEE を活用してデータの機密性を保証する。性能、データ一貫性、セ  キュリティは全てトレードオフであると考えられてきたが、本システムはそれら全てを提供する。  3.2   期待される効果  クラウドサービス (Microsoft Azure 、 AWS 、 Google Cloud) はクラウド事業者が管理者権限を有しているため  信頼できないが、 TEE の機能を提供している場合、信頼できないクラウドでも TEE 内部のデータベースは信頼  できる。ただ、これらのサービスは OSS ではないため、日本で同様のクラウド事業を立ち上げるにはコードが  ないため実現できない。そこで、本システムを OSS として公開することにより、同様のサービスを実現すること  ができるようになる。  また、本システムは Oracle の MySQL や Microsoft の EnclaveDB 、 Google の Google Cloud Spanner よりも高  性能かつ安全性の高いサービスを提供できるため、これらのユーザーを根こそぎ獲得できるポテンシャルを  秘めている。  5
4   具体的な進め方と予算  4.1   開発を行う場所  ●   自宅  4.2   使用する計算機環境  ●   ノート PC(Intel(R) Core(TM) i7-1185G7 CPU / 16GB RAM / WSL Ubuntu 20.04)  ●   デスクトップ PC(Intel(R) Core(TM) i5-10400F CPU / 64GB / WSL Ubuntu 20.04)  備考： SGXv1 では隔離実行環境である Enclave で利用できるメモリ領域は 128MB のみであり、 Intel  Core i シリーズと Intel Xeon シリーズの一部で提供されている。本システムは Enclave のメモリ領域とし  て 512GB まで利用可能である SGXv2 を使用することを想定している。 SGXv2 は Intel Xeon   第 3 世代以  降のプロセッサのみで提供されているため、開発は上記のもので行い、性能評価は SGXv2 が利用可能  な CPU を用いて行う予定である。  4.3   使用する言語、ツール  ●   C++  ●   SGX SDK(sgx_linux_x64_sdk_2.17.100.3 for Ubuntu 20.04-server)  備考： SGX の開発キットである SDK は Intel が提供している SGX SDK に加え、 Rust-SGX や  OpenEncalve 等も存在する。 SGX SDK を用いて開発を行う予定であるが、 Rust-SGX 、 OpenEncalve  に関しての調査が不十分であるため、開発期間中に調査を行い、 SGX SDK よりも優位性、利便性が確  認できた場合は開発キットを変更する可能性がある。  4.4   開発線表  4.5   開発に関わる時間帯と時間数  学部生であり、授業があるため正確な時間はわからないが、内部推薦で大学院進学予定であることと、卒  業単位はほとんど取得済みであるため、若干フレックスになるが、ほぼ毎日フルタイムで開発時間を確保でき  る。  6
4.6   予算内訳をまとめた表  4.6.1   予算内訳  活動時間   活動時間 × 時給  1440 時間   2,736,000 円  4.6.2   必要経費  ●   開発用 PC( 予算 :500,000 円 ) または、 Intel Xeon 3rd gen CPU を搭載した PC( 予算 :1,200,000  円 )  5   提案者の腕前を証明できるもの  ●   eSilo  ○   開発言語： C++  ○   Source: https://github.com/Noxy3301/enclaveSilo  Enclave 内で動作する Silo プログラムである。 Silo プログラムは CCBench のものを参考にしているが、  SGX は OS を信頼しない設計から、標準ライブラリやシステムコール等が利用できない仕様になってい  る。これに適応するように再実装、一部非対応関数 (e.g., chrono 、 condition_variable) の再実装を行っ  た。本プロジェクトはこのプログラムを基に開発を行う。  備考：第 158 回 OS 研究会に投稿した論文「 SGX を用いたセキュアな Silo の設計」で性能評価に用いたプ  ログラムであり、優秀若手発表賞を受賞した。  ●   B+tree  ○   開発言語： C++  ○   Source: https://github.com/Noxy3301/bptree  データベースに用いられる多分木型インデックスの 1 つである B+tree を実装したものである。  ●   IPX 所内用半自動化ツール  ○   開発言語： Python  インターン先である弁理士法人 IPX にて開発  した自動化ツールである。 OpenCV 、  pyautogui 、 selenium 等を用いて、特許出願処  理の一部自動化、拒絶査定時の引用文献自  動ダウンロード等の機能を提供している。ク  リックする箇所を事前に画像として抽出してお  き、現在のスクリーン上に一致する場所があ  るかを OpenCV を用いて探索し、該当箇所が  あった場合は pyautogui を利用してクリック、  ホットキー操作を行う。また、ブラウザ処理は  selenium を用いて要素検索を行い自動化を  行っている。  備考：特許取得済みである。 ( 特許 7166700)  6   プロジェクト遂行にあたっての特記事項  川島研究会に在籍している。川島研究会主宰者の川島英之准教授は本事業への応募を了解している。  7
7 IT 以外の勉強、特技、生活、趣味など  ソフトウェア作成以外の趣味としては、ゲームである。特に競技性の高い MOBA を好んで 1 日 3 〜 6 時間はプ  レイする。リアルタイムで変わる戦況とそれに応じた作戦を考え、緻密に実行する能力が問われるため、一筋  縄では上手くいかず、そこが非常に面白い点である。  勉強面では、高校生の頃から情報系に興味があり、趣味で基本情報技術者 (2019 年 11 月 ) と応用情報処理  技術者 (2021 年 12 月 ) の資格を保有している。  8   将来の IT について思うこと・期すること  近年、 Stable Diffusion や ChatGPT 、 BingAI を台頭に、目まぐるしい技術革新が一般人にも可視化されるよ  うになり、技術的特異点が着実に近づいてきていると言われている。このような技術は古来より積み重なる技  術の結晶であり、現在も学会等で新規技術の手法に関する研究が活発に行われている。日本も例にもれず、  このような学会や研究会が盛んに行われているため、これからも絶え間ない変化が起き続けることに胸を躍  らせている。  しかし、日本の IT 産業における競争力は低迷の一途を辿っているのにもかかわらず、 IT 産業の礎となる研  究活動に十分な資金が配分されていない、適切な場所に配分されていない現実に絶望を感じている。日本の  将来を担うであろうアカデミアの人間に支払われる給与は一般的な社会人の給与と大差なく、より良い待遇を  受けられる外資や大企業に優秀な人材が流れるのは至極当然であり、アカデミアに残る魅力が失われつつ  ある。予算配分に関しても、配分を行う人間が研究内容を理解できていないため、その研究の成果や出版  先、学会発表等ではなく、出版した本数のみで評価が決定しているのが現状である。私も日本の競争力を向  上させる人材になりたいと思うが、教授数名の話を聞く限り、面白みに欠けるのが所感である。研究活動に理  解のある人間が指揮を取れるようになることを切に願う。  参考文献  [1]   令和 4 年版情報通信白書 :  https://www.soumu.go.jp/johotsusintokei/whitepaper/ja/r04/pdf/n3600000.pdf  [2] VOTE FOR と LayerX 、インターネット投票を見据え、高い秘匿性と非改ざん性を備えた市民意見収集シス  テムをつくば市で実証へ : https://www.anonify.layerx.co.jp/post/pr20210921  [3] R. Popa, C. Redfield, N. Zeldovich, and H. Balakrishnan, “Cryptdb: protecting confidentiality with  encrypted query processing,” in SOSP, 2011, pp. 85–100.  [4] S. Tu, M. F. Kaashoek, S. Madden, and N. Zeldovich, “Processing analytical queries over encrypted  data,” PVLDB, vol. 6, no. 5, pp. 289–300, 2013.  [5] Panagiotis Antonopoulos, Arvind Arasu, Kunal D Singh, et al. 2020. Azure SQL Database Always  Encrypted. In Proceedings of the 2020 ACM SIGMOD International Conference on Management of Data.  1511–1525.  [6] Taehoon Kim, Joongun Park, Jaewook Woo, Seungheun Jeon, and Jaehyuk Huh. 2019. ShieldStore:  Shielded In-memory Key-value Storage with SGX. In Proceedings of the European Conference on  Computer Systems (EuroSys’19). 1–15.  [7] Christian Priebe, Kapil Vaswani, and Manuel Costa. 2018. EnclaveDB: A Secure Database Using  SGX. In Proceedings of the IEEE Symposium on Security and Privacy (SP’18). IEEE, 264–278.  [8] Tu, S., Zheng, W., Kohler, E., Liskov, B. and Madden, S.: Speedy transactions in multicore in-memory  databases, SOSP, pp. 18–32 (2013).  [9] Y. Mao, E. Kohler, and R. Morris. Cache craftiness for fast multicore key-value storage. In Eurosys,  2012.  8
