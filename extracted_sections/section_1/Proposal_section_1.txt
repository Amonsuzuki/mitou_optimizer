プロジェクト名： TEE を用いたセキュアかつ高性能なデータベースシステムの開発  申請者名：福山将英  【提案プロジェクト詳細】  1   何を作るか  1.1   概要  クラウドの利用は増加の一途を辿っている。令和 4 年版情報通信白書   [1] によると、 2020 年の時点でクラウド  サービス市場規模は 3281 億ドルと、 2017 年の 1640 億ドルと比較して 2 倍ほど拡大しており、今後も市場は拡  大していくと考えられている。 Google や Microsoft 、 Amazon などの大企業がクラウド事業を提供しており、それ  らは外部からの攻撃に対する様々な策を講じているため、安全であると考えられている。しかし、安心は満た  されていない。なぜなら、クラウド事業者は自身が提供しているマシンの管理者権限を有しているため、彼ら  がデータの読み取りや改ざんを行うかもしれない、という疑念が残るからだ。クラウドを利用するときは当然、  組織の重要なデータベースをクラウドにおいて運用するが、クラウド事業者等の管理者権限を有する者が不  正アクセスを行っていないことを保証するのは難しい。  本提案では、メニーコア環境下で性能を発揮できる、セキュアかつ高性能なトランザクション処理システムを  有するデータベースシステムを開発し、この問題を解決する。具体的には、 Intel SGX によって提供される隔離  実行環境である Enclave 内部に、トランザクション処理プロトコルの Silo 、インデックス及び機密データを配置す  ることにより、 OS やハイパーバイザ、クラウド事業者からの読み取り、改ざんを防ぐ。  図 1   システム概要図  本手法では、楽観的並行性制御法と並列ロギングを利用することによりトランザクション処理の性能を改善  する。また、書き出したログの整合性を保証するためにログ改ざん検知プロトコルを実装する。これらによって  データの機密性、完全性を保証する。  近年の実証実験では、 LayerX が提供する Intel SGX を基に開発された Anonify を用いて、インターネット投票  における秘匿性と完全性を保証するというものがある   [2] 。このような技術は金融や連合学習など、処理性能  を求められ、かつ情報資産を扱う分野において必要である。このプロジェクトは、データの機密性を保持しつ  つ処理性能を向上させることで、性能要求とセキュリティの確保のニーズを同時に満たしているため、情報資  産を扱うあらゆる分野において応用が可能であると考えている。  1.2   背景  セキュリティの重要性  近年、クラウドコンピューティングの普及が加速し、今や組織の機密情報などが含まれているデータベース  でさえも、クラウドに置いて運用するのが主流となっている。しかし、それはクラウド事業者を無条件に信頼す  るという前提が置かれている。従来のオンプレミス型であれば、外部からの不正アクセスに対する防御措置を  取る必要があるが、クラウドではそれに加えてクラウド事業者自身が不正アクセスを行わないかを考慮する必  1
要がある。なぜなら、クラウド事業者は自身のマシンの管理者権限を有しているため、メモリ上のデータは理  論上読み取ることが可能であるからだ。当然、機密情報は機密性を保証する必要があるが、クラウドコン  ピューティングでは上記の理由から機密性は保証されていない。  Confidential Computing  これを解決する技術として、準同型暗号を用いる秘密計算や、複数のサーバを用いる秘密分散が研究開発  されてきた。これに加えて、近年立ち上がりつつある技術に機密計算 (Confidential Computing) がある。機密  計算とはデータ処理を暗号化した状態で行い、データの機密性を確保するというものである。機密計算は  Trusted Execution Environment(TEE) と呼ばれる特殊なデバイスを用いる。 TEE は現実的なパフォーマンス  で機密性を保証できる技術として注目を集めている。 TEE はハードウェア支援によって隔離実行環境を提供  する。 TEE の 1 つである Intel SGX は、データを暗号化し、隔離実行環境である Enclave で保持する。データ処  理を行う際は、 CPU 内にある Memory Encryption Engine(MEE) によって復号化 / 暗号化され、 CPU キャッシュ  上のみ復号化される。上記の性質から、 Intel SGX は CPU と CPU 事業者である Intel だけを信頼すれば OS や  ハイパーバイザを信頼しなくてよい設計になっている。  従来研究・手法  データベースのセキュリティを確保する手法として様々な技術が提案されてきた。提案手法は大きく分けて 2  つあり、データを暗号化してそのまま処理する手法と、 TEE を用いてデータの機密性を保証する手法である。  データを暗号化してそのまま処理する手法としては、 CryptDB [3] や MONOMI [4] などが挙げられる。これら  は準同型暗号や検索可能暗号、順序保存暗号をデータに適用し、暗号化したままデータの処理を行うという  ものである。しかし、暗号演算による法外なオーバーヘッドが発生し、実行できる命令にも制限がかかるた  め、汎用的なデータベースに適用するには難しい。  TEE を用いてデータの機密性を確保する手法としては、 Always Encrypted [5] や ShieldStore [6] 、  EnclaveDB [7] などが挙げられる。これらは TEE である Intel SGX の機能を活用してデータの機密性を保証す  るというものである。しかし、旧来型の並行性制御法や逐次ロギングを採用していることから、スケールアップ  を行うことが難しい。  これらは総じて、今後の分散環境下におけるスケールアップが難しい設計になっており、加えて OSS として  提供されていないため、アルゴリズムの改善、エッジデバイスへの応用などが不可能であることはもちろんの  こと、クラウド事業者が機密性を保ったデータベースを提供することがそもそもできないのが現状である。  1.3   作るもの  以上のことを踏まえ、メニーコア環境下に置いてもスケーラブルであり、セキュリティが確保できる本提案は  価値がある。本プロジェクトでは、メニーコア環境下で性能を発揮できるセキュアかつ高性能なデータベースシ  ステムを開発する。  2
1.3.1   設計  図 2   本システムの概観  図 2 に本システムの概観を示す。本システムは Key-Value Store として開発を行う。データ構造は ( Key ,  Value ) のタプルであり、 Key は String 型、 Value は int 型で構成される。トランザクション処理エンジンとして Silo  [8] 、データ検索用のインデックスとして Masstree [9] を採用する。また、耐故障性を付与するためにロギング処  理を行い、その完全性を保証するためにログ改ざん検知プロトコルを実装する。  Key-Value Store Interface  KVS Inferface はユーザーがデータに対して検索及び更新を行うために使用するものである。ユーザーは  CLI に Read や Write 等の命令とその引数を入力し送信すると、 Enclave 内部に渡され、パーサーで解析、 Silo  エンジンでインデックスとテーブルに対して操作を行い、その結果を CLI に返却する。例えば、ユーザーが  (“Hoge”, 100) を追加したい場合は、「 Insert Hoge 100 」と入力し、正常に処理が完了した場合は完了通知、  既に Key が使用されている場合はエラーを返しその旨を通知する。この一連の処理は Enclave 内部で実行さ  れるため、データの機密性が保証されている。使用できる命令として Read, Write, Insert, Remove, Scan を実  装する。これらの命令は必要に応じて 1 つ以上の引数を受け取り処理を行う。詳細は以下のとおりである。  ●   Read( Key )  ○   Read 命令は既にテーブルに存在する Key を検索し、その値を返却する。  ○   成功時の返り値： Value  ○   失敗時の返り値： ERROR( Key が存在しない、不適切な引数等 )  ●   Write( Key ,   Value )  ○   Write 命令は既にテーブルに存在する Key に対応する Value を書き換える。  ○   成功時の返り値： SUCCESS  ○   失敗時の返り値： ERROR( Key が存在しない、不適切な引数等 )  ●   Insert( Key ,   Value )  ○   Insert 命令はテーブルに新しく ( Key ,   Value ) のデータを追加する。  ○   成功時の返り値： SUCCESS  ○   失敗時の返り値： ERROR( Key が既に存在する、不適切な引数等 )  ●   Remove( Key ,   Value )  ○   Remove 命令は既にテーブルに存在する ( Key ,   Value ) のデータを削除する  ○   成功時の返り値： SUCCESS  ○   失敗時の返り値： ERROR( Key が存在しない、不適切な引数等 )  ●   Scan( Key ,   number )  ○   Scan 命令は Key を始めに number 個分の ( Key ,   Value ) データを検索し、それらの Key と  Value を返却する。  3
○   成功時の返り値： number 個分の ( Key ,   Value )  ○   失敗時の返り値： ERROR( Key が存在しない、不適切な引数等 )  Silo  Silo はメニーコアと大容量メモリを活用できるように設計されたトランザクション処理技法である。  Silo は読み取りロックを取得せず、代わりに検証を行い整合性を保証する楽観的並行性制御であり、書き込  みロックに関してもロックマネージャで集中管理せず、各データがロック状態を保持する非中央型ロック機構を  採用している。これにより、全体のロック時間が減少するため、メニーコア環境でも高いスループットを達成す  ることが知られている。また、 Silo は並列ロギングが可能な設計になっているため、並列性を有する近代的ス  トレージデバイスを活用して性能低下を抑えることができる。  図 3   Silo の概観  図 3 に Silo の概観を示す。 Silo はトランザクションを処理するワーカースレッドと、ロギング処理を行うロガース  レッドによって構成されている。各ワーカースレッドはテーブルのデータを用いてトランザクションを実行する。  実行が完了しコミットフェーズに入ると、ワーカースレッドはトランザクションの書き込みリストに関するログレ  コードを生成し、ワーカースレッドが保有するログバッファに登録する。  ログバッファが一杯になるかエポックが更新されると、ワーカースレッドはログバッファを対応するロガース  レッドのログキューに追加し、待機しているロガースレッドを起床させる。ワーカースレッドはログバッファを複  数保有しており、ワーカースレッドはログバッファをロガースレッドのログキューに追加後、現在のログバッファ  を置き換えて処理を続行する。  起床したロガースレ...