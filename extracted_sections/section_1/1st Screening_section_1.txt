プロジェクト名： Capability-Based Microkernel によるセキュアなユーザーレベルメモリ管理システム  申請者名：伊組烈火  【提案プロジェクト詳細】  1.   なにをつくるか  概要  Object-Capability Model による Capability-Based Microkernel をベースにした OS と ,   それを用いたユーザーラ  ンドメモリ管理システムを提案する .  この提案はセキュアかつ柔軟で安定したシステムの構築を可能とするものであり ,   ユーザーランドソフトウェアの  互換性を保ちつつ ,   最適化されたメモリ管理システムを提供可能である .  これにより，現代のプログラム技術におけるコンテナや Wasm, Hypervisor のような仮想化機構に対してより高レ  ベルの最適化を提供することが可能になる .  本提案で開発するものは以下の 3 つである :  ●   A9N : Capability-Based Microkernel  ●   KOITO : A9N をコアとする OS  ●   ULMM Server : KOITO 上で動作する ,   ユーザーレベルメモリ管理サーバー  ○   SLAB Allocator  ○   Buddy Memory Allocator  コンピューターの民主化による IoT の拡大  近年 ,   技術革新によるコンピュータの民主化は大きなムーブメントを引き起こしている .  ムーアの法則で予見されたように , CPU に含まれる面積当たりのトランジスタ数は指数関数的に増大した .   半導  体技術の進歩はよりコンパクトで低価格なコンピューターの発達を促し ,   21 世紀の携帯端末は   従来持っていた  電話機能のみならず ,   インターネットを介した広範なネットワークへの接続や高度なコンピューティング能力を獲  得し ,   より賢いものへと進化している .  これにより IoT という概念が一般化し ,   生活と密接かつ重大な結合を果たしている現在 ,   家の施錠システムまでも  がネットワークに参加するようになり ,   一つのモノに対して与えられるオペレーションが高度なものへと変貌を遂  げている .   そのニーズに応えるため ,   ありとあらゆるシステムに OS が搭載されるようになった .   この現象は ,   コン  ピュータの民主化による IoT の拡大と言えるだろう .  カーネルと OS  コンピュータの民主化が進む中で ,   カーネルと OS はますます重要な役割を果たすようになった .  カーネルは ,   システムとハードウェアを接続するための ,   プリミティブな API サブセットを提供するものである .   この  カーネルを基に ,   特定のユースケースを満たすためのソフトウェア群が一つのパッケージとなり , OS が構成され  る .  そのため ,   異なる OS でも同一のカーネルを使用しているケースが多数存在する .   代表的なもので言えば ,   数多  の Linux ディストリビューションや Android は Linux カーネルが用いられている .   また , Apple 社の iOS や macOS に  は XNU カーネルが用いられている .   カーネルが提供する API が共通であるため ,   各 OS を構成するソフトウェアは  高い互換性を持つ .  モノリシックなカーネル  従来のカーネルでは ,   一般的なシステム要求に対応するため ,   カーネル自体にその機能を含めてしまうというモ  ノリシックな構造を持っている .  例えば ,   デバイスドライバやファイルシステム ,   ネットワークに接続するためのプロトコル・スタックなどはカーネル  内部へ組み込まれる .   このアプローチは高速な動作を可能とするが ,   コンポーネントの拡大に伴いカーネルが肥  大化してしまうという問題を持っている .   また ,   構成要素である各コンポーネントのコードを書き換えるたびにカー  ネルの再ビルドが必要となる .   コードベースが十分に小さいうちは管理が可能であるが ,   開発の進行につれて保
守性と柔軟性を失ってしまい ,   誰もシステムの全容を把握できなくなる .   この状態ではカーネルの汎用性が低下  し ,   機能要件の小さな目的特化型の OS は ,   カーネルの提供する不要な機能に依存することとなる .   これにより ,  同じカーネルを組み込みシステムとデスクトップシステムの両方で使用するのは困難になる .  また ,   カーネル内に存在するコンポーネントは当然ながらカーネル空間上で動作する .   そのため , 1 つでも不安定  なコンポーネントが存在すると ,   その影響が最重要であるはずのカーネル全体に波及してしまう .  簡単に言えば ,   カーネルの担う仕事があまりにも多すぎるのである .  マイクロカーネル  モノリシックなカーネルの持つ問題を解消するため ,   マイクロカーネルというアイデアが提案された .  カーネルは最小の特権操作のみをユーザーに提供し ,   モノリシックカーネルにおける多くのカーネル内コンポー  ネントをユーザーランドへ移動することで ,   文字通り ” マイクロ ” にするというものである .   多くのマイクロカーネル  は割り込みやタイマー割り込み , IPC などの切り離せない操作のみを提供する .  切り離されたコンポーネントは IPC 機構によってクライアント - サーバーモデル [Tanenbaum, 2007] を実現し ,   協調  動作を行う .  この設計は先述したモノリシックカーネルの問題点を解消しているが ,   完璧ではない . IPC はユーザーからカーネ  ル ,   またその逆方向へのコンテキストスイッチを伴うため ,   単なる関数呼び出しで済んでいたものに対してオー  バーヘッドが課せられる .   しかしながら , L4 マイクロカーネルの作者である Jochen Liedtke が IPC を注意深く設計  することで高速な IPC を実現可能なことを示したことや [Liedtke, 1995],   技術革新によってコンピューターが高速  化したことに伴い ,   現代においては十二分に実用可能なものとなった .   そのため ,   ここでは問題としないことにす  る .  機構と方針の分離  マイクロカーネルが採用したアプローチは ,   機構と方針の分離 [Levin et al, 1975] という設計原則に一般化でき  る .   実装詳細である機構は ,   より抽象を表す方針を示してはならないという原則である .   マイクロカーネルにおい  ては ,   機構が IPC や割り込みを操作するための仕組みであり ,   方針はユーザーであるクライアントの操作詳細を  表す .  カーネルによるスケジューリング方針の決定  機構と方針の分離原則を適用すると ,   スケジューリングやメモリ管理システムの方針も分離できそうに思えるが ,  自体はそれほど単純ではない .  多くのマイクロカーネルにおいて ,   スケジューリングのための機構であるクロックドライバーはカーネル内部に存  在する .   何故なら ,   常にプリエンプティブマルチタスクを行うカーネルにとって ,   クロックサーバーからの IPC コスト  が無視できないものであるからだ .  通常のクライアント - サーバー間の IPC コストは全体から見たときにそれほど大きいものではない .   しかし ,   クロック  は 100-500hz という高頻度で発生するため ,   処理の大半を IPC が占める可能性が大きいためである .  そのため ,   妥協案として実行可能コンテキストごとの優先度設定機能が提供されている .  カーネルによるメモリ管理方針の決定  では ,   メモリ管理システムではどうだろうか .  ユーザーランドでメモリ管理方針を決定可能なマイクロカーネルは存在するが ,   多くの場合カーネル内に統合さ  れている .  では ,   何故多くのケースにおいてメモリ管理方針が移動できないのだろうか .   それは ,   セキュリティ上の問題に起  因する .  ユーザーが直接ページテーブルを操作できる場合 ,   自分の所有していない物理アドレスをマップすることや ,   他コ  ンテキストが持つアドレス空間を破壊することが可能となり ,   コンテキスト間の分離が損なわれてしまう .  MINIX のように , VM サーバーのような限定されたプロセスのみが操作可能とすることも現実的ではない .   このよ  うなユーザーに対する無条件の信頼は ,   悪意のあるサーバーや攻撃者に対する安全性が保証できないからで  ある .   このような設計は ,   与えたいアクセス権限以上の操作を可能としてしまうため ,   最小特権の原則 [Saltzer,  1974] に反している .  Capability  スケジューリング方針はハードウェア制約によって決定されるため ,   変更は困難である .   一方 ,   メモリ管理方針は ,  最小特権の原則に基づいた適切なセキュリティ機構を導入することにより ,   ユーザーレベルで決定することが可
能になる .  Object-Capability Model  その機構の実現には , Object-Capability Model を使用した Capability-Based Security を導入する .  Object-Capability Model とは ,   オブジェクトに対する操作権限を基にしたセキュリティモデルである .  ユーザーは特権的操作を行うために ,   自分の持つ Capability の指定子と ,   その Capability に対する操作を指定す  る必要がある .   ユーザーは自分の持たない Capability に対する操作手段は持ち得ず ,   割り当てられた権限以上  のことは行うことができない .   これは最小特権の原則を満たす .  A9N Microkernel  A9N Microkernel は ,   これまで記した問題に対する解法を単一のマイクロカーネルとして統合したものであり ,   私  が以前から開発しているものである .  A9N は ,   システム起動時にユーザーに許可する Capability を ,   Unix や Linux の Init に該当する実行可能コンテキ  スト Alpha へ渡す .   この Alpha が与えられた Capability をどう使用するかは , A9N をコアとする OS の実装者に一任  されている .   ユーザー空間上で動作する Alpha こそが OS の性格を決定するものであり ,   カーネルよりも上位レイ  ヤー部分の柔軟性を決定する .  シンプルなインターフェース  A9N はすべての特権操作を IPC メカニズムによって行う .   具体的には ,   IPC システムコールの第一引数として  Capability の識別子である Descriptor を指定することによって行われる .  この機構により , A9N のシステムコールは ipc() と yield() の２つのみという ,   究極的にシンプルなものとなる .  カーネルオブジェクト作成時の...