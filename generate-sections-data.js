#!/usr/bin/env node
/**
 * Generate sections data from text files
 * This script reads the extracted_sections directory and generates a TypeScript module
 */

const fs = require('fs');
const path = require('path');

const SECTION_TITLES = [
  { id: 1, title: '何をつくるか' },
  { id: 2, title: '斬新さの主張、期待される効果など' },
  { id: 3, title: 'どんな出し方を考えているか' },
  { id: 4, title: '具体的な進め方と予算' },
  { id: 5, title: '私の腕前を証明できるもの' },
  { id: 6, title: 'プロジェクト遂行にあたっての特記事項' },
  { id: 7, title: 'ソフトウェア作成以外の勉強、特技、生活、趣味など' },
  { id: 8, title: '将来のソフトウェア技術に対して思うこと・期待すること' }
];

// Map of filenames to project info
const PROJECT_INFO = {
  'Proposal': { category: 'open' },
  'プロジェクト詳細': { category: 'open' },
  'Yoshikiさん': { category: 'open' },
  '松浦さん': { category: 'open' },
  '1st Screening': { category: 'open' },
  '日本語入力システム': { category: 'open' },
  'SmartGoalプロジェクト': { category: 'open' },
  'Report': { category: 'open' },
  '水野さん': { category: 'closed' },
  '和田さん': { category: 'closed' }
};

function readSectionFile(sectionDir, filename) {
  const filepath = path.join(sectionDir, filename);
  try {
    if (fs.existsSync(filepath)) {
      const content = fs.readFileSync(filepath, 'utf-8');
      // Check if it's the empty placeholder
      if (content.includes('このセクションの内容は抽出されませんでした')) {
        return '';
      }
      return content;
    }
  } catch (error) {
    console.error(`Error reading ${filepath}:`, error);
  }
  return '';
}

function generateSectionsData() {
  const extractedDir = path.join(__dirname, 'extracted_sections');
  
  if (!fs.existsSync(extractedDir)) {
    console.error('extracted_sections directory does not exist!');
    process.exit(1);
  }
  
  const projects = [];
  
  // Iterate through each project name
  for (const [projectName, info] of Object.entries(PROJECT_INFO)) {
    const sections = {};
    
    // Read each section for this project
    for (let i = 1; i <= 8; i++) {
      const sectionDir = path.join(extractedDir, `section_${i}`);
      const filename = `${projectName}_section_${i}.txt`;
      sections[i] = readSectionFile(sectionDir, filename);
    }
    
    projects.push({
      name: projectName,
      filename: '', // Not needed anymore since we're reading from text files
      category: info.category,
      sections: sections
    });
  }
  
  return {
    generated: new Date().toISOString(),
    sectionTitles: SECTION_TITLES,
    projects: projects
  };
}

// Generate the data
const sectionsData = generateSectionsData();

// Write as TypeScript module
const tsContent = `/**
 * Generated sections data from extracted text files
 * This file is auto-generated by generate-sections-data.js
 * DO NOT EDIT MANUALLY
 */

export default ${JSON.stringify(sectionsData, null, 2)};
`;

fs.writeFileSync(
  path.join(__dirname, 'extracted-sections-data.ts'),
  tsContent,
  'utf-8'
);

console.log('✓ Generated extracted-sections-data.ts');
console.log(`  Total projects: ${sectionsData.projects.length}`);
console.log(`  Generated at: ${sectionsData.generated}`);
